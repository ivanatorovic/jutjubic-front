<div class="page">
  <header class="topbar">
    <a class="brand" routerLink="/videos" aria-label="jutjubic home">
      <span class="logo">‚ñ∂</span>
      <span class="name">jutjubic</span>
    </a>

    <div class="top-actions">
      <ng-container *ngIf="!isLoggedIn(); else logged">
        <button type="button" class="btn ghost" routerLink="/login">Prijava</button>
        <button type="button" class="btn primary" routerLink="/register">Registracija</button>
      </ng-container>

      <ng-template #logged>
        <button class="btn ghost" routerLink="/upload">Upload</button>
        <button type="button" class="btn ghost" routerLink="/trending">Trending</button>
        <button type="button" class="btn ghost" (click)="openWatchPartyRooms()">Party Watch</button>

        <button
          class="btn ghost"
          *ngIf="currentUserId !== null"
          [routerLink]="['/user-profile', currentUserId]"
        >
          Profil
        </button>

        <button class="btn primary" (click)="logout()">Logout</button>
      </ng-template>
    </div>
  </header>

  <main class="content">
    <div class="watch-layout">
      <section class="main-col">
        <div class="premiere" *ngIf="premiereActive">
          <div class="prem-title">Premijera</div>
          <div class="prem-sub">
            Poƒçinje za: <b>{{ premiereCountdown }}</b>
          </div>
          <div class="prem-sub muted">Zakazano {{ premiereStartLocal }}</div>
        </div>

      
        <div class="ended-screen" *ngIf="premiereEnded">Premijera je zavr≈°ena</div>

      
        <div class="player-wrap" *ngIf="src && !premiereActive && !premiereEnded">
          <video
            #player
            class="player"
            [src]="src"
            controls
            [muted]="true"
            playsinline
            preload="metadata"
            (canplay)="tryAutoplay(player)"
            (pause)="onPause($event)"
            (keydown)="onSpace($event)"
            (timeupdate)="onTimeUpdate(player)"
            (seeking)="onSeeking(player)"
            (ended)="onEnded()"
          ></video>
        </div>

        <div *ngIf="error" class="state error">{{ error }}</div>

        <div *ngIf="!error && metaLoading" class="state">Uƒçitavam detalje‚Ä¶</div>
        <div *ngIf="!error && !metaLoading && metaError" class="state warn">{{ metaError }}</div>

        <ng-container *ngIf="video as v">
          <h1 class="title">{{ v.title }}</h1>

          <div class="tags" *ngIf="v.tags && v.tags.length">
            <span class="tag" *ngFor="let t of v.tags">#{{ t }}</span>
          </div>

          <div class="meta-row">
            <div class="author">
              <div
                class="avatar clickable"
                (click)="openUser(v.userId, $event)"
                role="link"
                tabindex="0"
                (keydown.enter)="openUser(v.userId, $event)"
              >
                {{ (v.username ?? '?').slice(0, 1).toUpperCase() }}
              </div>

              <div class="author-text">
                <div
                  class="username clickable"
                  (click)="openUser(v.userId, $event)"
                  role="link"
                  tabindex="0"
                  (keydown.enter)="openUser(v.userId, $event)"
                >
                  {{ v.username ?? 'Nepoznat autor' }}
                </div>

                <div class="time">{{ formatTime(v.createdAt) }}</div>

                <div class="location" *ngIf="v.location && v.location.trim()">{{ v.location }}</div>
              </div>
            </div>

            <div class="stats"  *ngIf="!hideStats">
              <div class="views">{{ v.viewCount ?? 0 }} pregleda</div>

              <div class="stats-chips">
                <button
                  type="button"
                  class="chip like-chip"
                  [class.liked]="likedByMe"
                  [disabled]="likeBusy"
                  (click)="toggleLike($event)"
                >
                  <span class="icon">üëç</span>
                  {{ v.likeCount ?? 0 }}
                </button>

                <span class="chip" *ngIf="!hideComments">
                  üí¨ {{ v.commentCount ?? comments.length }}
                </span>
              </div>
              <div class="like-warning" *ngIf="likeAuthError">Mora≈° biti ulogovan da lajkuje≈°.</div>
            </div>
          </div>

          <p class="desc" *ngIf="v.description">{{ v.description }}</p>

          <!-- Watch Party akcija (iznad komentara) -->
          <div class="wp-actions" *ngIf="video && !metaLoading">
            <button
              type="button"
              class="btn wp-btn"
              (click)="openPartyPicker($event)"
              [disabled]="addToPartyBusy || addedToParty"
            >
              <span class="wp-plus">Ôºã</span>
              {{
                addedToParty
                  ? 'Dodato u sobu ' + (addedRoomId ?? '')
                  : addToPartyBusy
                    ? 'Dodajem‚Ä¶'
                    : 'Watch Party'
              }}
            </button>

            <div class="state error mini" *ngIf="addToPartyError">{{ addToPartyError }}</div>
          </div>

          <!-- Popup/overlay za izbor sobe -->
          <div class="wp-overlay" *ngIf="partyPickerOpen" (click)="closePartyPicker()">
            <div class="wp-modal" (click)="$event.stopPropagation()">
              <div class="wp-modal-head">
                <div class="wp-modal-title">Izaberi sobu</div>
                <button class="btn ghost" (click)="closePartyPicker()">Zatvori</button>
              </div>

              <div class="state mini" *ngIf="roomsLoading">Uƒçitavam tvoje sobe‚Ä¶</div>
              <div class="state warn mini" *ngIf="!roomsLoading && roomsError">
                {{ roomsError }}
              </div>

              <div class="wp-room-list" *ngIf="!roomsLoading && !roomsError">
                <div class="state mini" *ngIf="myRooms.length === 0">
                  Nema≈° nijednu sobu. Prvo napravi Watch Party sobu.
                </div>

                <button
                  type="button"
                  class="wp-room"
                  *ngFor="let r of myRooms"
                  (click)="addCurrentVideoToRoom(r.roomId)"
                  [disabled]="addToPartyBusy"
                >
                  <div class="wp-room-top">
                    <div class="wp-room-code">{{ r.roomId }}</div>
                    <div class="wp-room-meta">üë• {{ r.memberCount }} ‚Ä¢ üéûÔ∏è {{ r.videoCount }}</div>
                  </div>
                  <div class="wp-room-sub">
                    Host: {{ r.hostUsername ?? 'User #' + r.hostUserId }}
                  </div>
                </button>
              </div>

              <div class="state error mini" *ngIf="addToPartyError">{{ addToPartyError }}</div>
            </div>
          </div>

          <section class="comments" *ngIf="video && !metaLoading && !hideComments">
            <div class="comments-head">
              <div class="comments-title">Komentari ({{ commentsTotal || comments.length }})</div>
            </div>

            <div class="comment-compose" *ngIf="video as v">
              <div class="compose-row">
                <div class="c-avatar me">
                  {{ (currentUsername ?? '?').slice(0, 1).toUpperCase() }}
                </div>

                <div class="compose-box">
                  <textarea
                    class="compose-input"
                    rows="1"
                    [value]="newComment"
                    (input)="onCommentInput($event)"
                    placeholder="Dodaj komentar‚Ä¶"
                    [disabled]="postingComment"
                  ></textarea>

                  <div
                    class="compose-actions"
                    *ngIf="newComment.trim().length > 0 || composeFocused"
                  >
                    <button
                      type="button"
                      class="btn ghost"
                      (click)="cancelComment()"
                      [disabled]="postingComment"
                    >
                      Otka≈æi
                    </button>

                    <button
                      type="button"
                      class="btn primary"
                      (click)="postComment()"
                      [disabled]="postingComment || !newComment.trim()"
                    >
                      {{ postingComment ? '≈†aljem‚Ä¶' : 'Komentari≈°i' }}
                    </button>
                  </div>

                  <div class="state error mini" *ngIf="postError">{{ postError }}</div>
                </div>
              </div>
            </div>

            <div *ngIf="commentsLoading" class="state">Uƒçitavam komentare‚Ä¶</div>
            <div *ngIf="!commentsLoading && commentsError" class="state warn">
              {{ commentsError }}
            </div>

            <div *ngIf="!commentsLoading && !commentsError && comments.length === 0" class="state">
              Nema komentara jo≈°.
            </div>

            <article class="comment" *ngFor="let c of comments">
              <div
                class="c-avatar clickable"
                (click)="openUser(c.userId, $event)"
                role="link"
                tabindex="0"
                (keydown.enter)="openUser(c.userId, $event)"
              >
                {{ (c.username ?? '?').slice(0, 1).toUpperCase() }}
              </div>

              <div class="c-body">
                <div class="c-head">
                  <span
                    class="c-user clickable"
                    (click)="openUser(c.userId, $event)"
                    role="link"
                    tabindex="0"
                    (keydown.enter)="openUser(c.userId, $event)"
                  >
                    {{ c.username }}
                  </span>
                  <span class="dot">‚Ä¢</span>
                  <span class="c-time">{{ formatTime(c.createdAt) }}</span>
                </div>
                <div class="c-text">{{ c.text }}</div>
              </div>
            </article>

            <div
              class="load-more"
              *ngIf="!commentsLoading && !commentsError && comments.length > 0 && !commentsLast"
            >
              <button class="btn ghost" (click)="loadMoreComments()" [disabled]="loadingMore">
                {{ loadingMore ? 'Uƒçitavam‚Ä¶' : 'Uƒçitaj jo≈°' }}
              </button>
            </div>
          </section>
        </ng-container>
      </section>

      <aside class="side-col">
        <div class="chat-card" *ngIf="showChat">
          <div class="chat-head">
            <div class="chat-title">Live chat</div>
            <div class="chat-sub" *ngIf="id">Video #{{ id }}</div>
          </div>

          <div class="chat-messages">
            <div class="chat-empty" *ngIf="chatMessages.length === 0">
              Nema poruka jo≈°. (Videƒáe≈° samo poruke od trenutka ulaska)
            </div>

            <div class="chat-msg" *ngFor="let m of chatMessages">
              <div class="chat-meta">
                <b>{{ m.sender }}</b>
                <span class="dot">‚Ä¢</span>
                <small>{{ formatTime(m.ts) }}</small>
              </div>
              <div class="chat-text">{{ m.content }}</div>
            </div>
          </div>

          <div class="chat-input">
            <input
              [(ngModel)]="chatText"
              placeholder="Napi≈°i poruku‚Ä¶"
              (keyup.enter)="sendChat()"
              [disabled]="!isLoggedIn()"
            />
            <button
              class="btn primary"
              (click)="sendChat()"
              [disabled]="!isLoggedIn() || !chatText.trim()"
            >
              Po≈°alji
            </button>
          </div>

          <div class="chat-hint" *ngIf="!isLoggedIn()">Mora≈° biti ulogovan da pi≈°e≈° poruke.</div>
        </div>

        <div class="side-title">Ostali videi</div>

        <div *ngIf="sideLoading" class="state mini">Uƒçitavam‚Ä¶</div>
        <div *ngIf="!sideLoading && sideError" class="state warn mini">{{ sideError }}</div>

        <a class="side-item" *ngFor="let it of sideVideos" [routerLink]="['/watch', it.id]">
          <img class="thumb" [src]="videoService.thumbnailUrl(it.id)" alt="" loading="lazy" />

          <div class="side-meta">
            <div class="side-item-title">{{ it.title }}</div>
            <div class="side-item-sub">
              <span class="muted">{{ it.username ?? 'Nepoznat autor' }}</span>
              <span class="dot">‚Ä¢</span>
              <span class="muted">üëÅÔ∏è {{ it.viewCount ?? 0 }}</span>
            </div>
          </div>
        </a>
      </aside>
    </div>
  </main>
</div>
