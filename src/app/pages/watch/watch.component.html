<div class="page">
  <header class="topbar">
    <a class="brand" routerLink="/videos" aria-label="jutjubic home">
      <span class="logo">‚ñ∂</span>
      <span class="name">jutjubic</span>
    </a>

    <!-- DESNO -->
    <div class="top-actions">
      <!-- ako nije ulogovan -->
      <ng-container *ngIf="!isLoggedIn(); else logged">
        <button type="button" class="btn ghost" routerLink="/login">Prijava</button>
        <button type="button" class="btn primary" routerLink="/register">Registracija</button>
      </ng-container>

      <!-- ako jeste ulogovan -->
      <ng-template #logged>
        <button class="btn ghost" routerLink="/upload">Upload</button>

        <button
          class="btn ghost"
          *ngIf="currentUserId !== null"
          [routerLink]="['/user-profile', currentUserId]"
        >
          Profil
        </button>

        <button class="btn primary" (click)="logout()">Logout</button>
      </ng-template>
    </div>
  </header>

  <main class="content">
    <!-- PLAYER uvek -->
    <div class="player-wrap" *ngIf="src">
      <video class="player" [src]="src" controls autoplay preload="metadata"></video>
    </div>

    <!-- hard error (lo≈° id) -->
    <div *ngIf="error" class="state error">{{ error }}</div>

    <!-- meta state -->
    <div *ngIf="!error && metaLoading" class="state">Uƒçitavam detalje‚Ä¶</div>
    <div *ngIf="!error && !metaLoading && metaError" class="state warn">{{ metaError }}</div>

    <!-- ‚úÖ META ƒçim postoji video -->
    <ng-container *ngIf="video as v">
      <h1 class="title">{{ v.title }}</h1>

      <div class="meta-row">
        <!-- LEVO: autor -->
        <div class="author">
          <div
            class="avatar clickable"
            (click)="openUser(v.userId, $event)"
            role="link"
            tabindex="0"
            (keydown.enter)="openUser(v.userId, $event)"
          >
            {{ (v.username ?? '?').slice(0, 1).toUpperCase() }}
          </div>

          <div>
            <div
              class="username clickable"
              (click)="openUser(v.userId, $event)"
              role="link"
              tabindex="0"
              (keydown.enter)="openUser(v.userId, $event)"
            >
              {{ v.username ?? 'Nepoznat autor' }}
            </div>
            <div class="time">{{ formatTime(v.createdAt) }}</div>
          </div>
        </div>
        <div class="extra" *ngIf="(v.location && v.location.trim()) || (v.tags && v.tags.length)">
          <span class="chip" *ngIf="v.location && v.location.trim()">üìç {{ v.location }}</span>

          <ng-container *ngIf="v.tags && v.tags.length">
            <span class="chip tag" *ngFor="let t of v.tags">#{{ t }}</span>
          </ng-container>
        </div>
        <!-- DESNO: stats -->
        <div class="stats">
           <span class="chip">üëÅÔ∏è {{ v.viewCount ?? 0 }}</span>
                  <button
  type="button"
  class="chip like-chip"
  [disabled]="!isLoggedIn() || likeBusy"
  (click)="toggleLike($event)"
>
  üëç {{ v.likeCount ?? 0 }}
</button>

    
          <span class="chip">üí¨ {{ v.commentCount ?? comments.length }}</span>
        </div>
      </div>

      <p class="desc" *ngIf="v.description">{{ v.description }}</p>

      <!-- KOMENTARI -->
      <section class="comments">
        <div class="comments-head">
          <div class="comments-title">Komentari ({{ commentsTotal || comments.length }})</div>
        </div>

        <!-- DODAJ KOMENTAR -->
        <div class="comment-compose" *ngIf="video as v">
          <div class="compose-row">
            <div class="c-avatar me">
              {{ (currentUsername ?? '?').slice(0, 1).toUpperCase() }}
            </div>

            <div class="compose-box">
              <textarea
                class="compose-input"
                rows="1"
                [value]="newComment"
                (input)="onCommentInput($event)"
                placeholder="Dodaj komentar‚Ä¶"
                [disabled]="postingComment"
              ></textarea>

              <div class="compose-actions" *ngIf="newComment.trim().length > 0 || composeFocused">
                <button
                  type="button"
                  class="btn ghost"
                  (click)="cancelComment()"
                  [disabled]="postingComment"
                >
                  Otka≈æi
                </button>

                <button
                  type="button"
                  class="btn primary"
                  (click)="postComment()"
                  [disabled]="postingComment || !newComment.trim()"
                >
                  {{ postingComment ? '≈†aljem‚Ä¶' : 'Komentari≈°i' }}
                </button>
              </div>

              <div class="state warn mini" *ngIf="postError">{{ postError }}</div>
            </div>
          </div>
        </div>

        <div *ngIf="commentsLoading" class="state">Uƒçitavam komentare‚Ä¶</div>
        <div *ngIf="!commentsLoading && commentsError" class="state warn">{{ commentsError }}</div>

        <div *ngIf="!commentsLoading && !commentsError && comments.length === 0" class="state">
          Nema komentara jo≈°.
        </div>

        <article class="comment" *ngFor="let c of comments">
          <div
            class="c-avatar clickable"
            (click)="openUser(c.userId, $event)"
            role="link"
            tabindex="0"
            (keydown.enter)="openUser(c.userId, $event)"
          >
            {{ (c.username ?? '?').slice(0, 1).toUpperCase() }}
          </div>

          <div class="c-body">
            <div class="c-head">
              <span
                class="c-user clickable"
                (click)="openUser(c.userId, $event)"
                role="link"
                tabindex="0"
                (keydown.enter)="openUser(c.userId, $event)"
              >
                {{ c.username }}
              </span>
              <span class="dot">‚Ä¢</span>
              <span class="c-time">{{ formatTime(c.createdAt) }}</span>
            </div>
            <div class="c-text">{{ c.text }}</div>
          </div>
        </article>
        <div
          class="load-more"
          *ngIf="!commentsLoading && !commentsError && comments.length > 0 && !commentsLast"
        >
          <button class="btn ghost" (click)="loadMoreComments()" [disabled]="loadingMore">
            {{ loadingMore ? 'Uƒçitavam‚Ä¶' : 'Uƒçitaj jo≈°' }}
          </button>
        </div>
      </section>
    </ng-container>
  </main>
</div>
